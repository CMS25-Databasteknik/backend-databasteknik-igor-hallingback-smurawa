using Backend.Application.Modules.InPlaceLocations;
using Backend.Application.Modules.InPlaceLocations.Inputs;
using Backend.Domain.Modules.InPlaceLocations.Contracts;
using Backend.Domain.Modules.InPlaceLocations.Models;
using NSubstitute;

namespace Backend.Tests.Unit.Application.Modules.InPlaceLocations;

public class InPlaceLocationService_Tests
{
    #region CreateInPlaceLocationAsync Tests

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_Success_When_Valid_Input()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var expectedInPlaceLocation = new InPlaceLocation(1, 1, 101, 30);

        mockRepo.AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(expectedInPlaceLocation);

        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, 101, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(201, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(1, result.Result.LocationId);
        Assert.Equal(101, result.Result.RoomNumber);
        Assert.Equal(30, result.Result.Seats);
        Assert.Equal("In-place location created successfully.", result.Message);

        await mockRepo.Received(1).AddAsync(
            Arg.Is<InPlaceLocation>(ipl => ipl.LocationId == 1 && ipl.RoomNumber == 101 && ipl.Seats == 30),
            Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_Input_Is_Null()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.CreateInPlaceLocationAsync(null!, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Equal("In-place location cannot be null.", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_LocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(0, 101, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_LocationId_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(-1, 101, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_RoomNumber_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, 0, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_RoomNumber_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, -1, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_Seats_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, 101, 0);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_BadRequest_When_Seats_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, 101, -1);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task CreateInPlaceLocationAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(Task.FromException<InPlaceLocation>(new Exception("Database error")));

        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(1, 101, 30);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("An error occurred while creating the in-place location", result.Message);
        Assert.Contains("Database error", result.Message);
    }

    [Theory]
    [InlineData(1, 101, 30)]
    [InlineData(1, 102, 25)]
    [InlineData(2, 201, 50)]
    public async Task CreateInPlaceLocationAsync_Should_Create_InPlaceLocation_With_Various_Valid_Inputs(
        int locationId, int roomNumber, int seats)
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var expectedInPlaceLocation = new InPlaceLocation(1, locationId, roomNumber, seats);

        mockRepo.AddAsync(Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(expectedInPlaceLocation);

        var service = new InPlaceLocationService(mockRepo);
        var input = new CreateInPlaceLocationInput(locationId, roomNumber, seats);

        // Act
        var result = await service.CreateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(201, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(locationId, result.Result.LocationId);
        Assert.Equal(roomNumber, result.Result.RoomNumber);
        Assert.Equal(seats, result.Result.Seats);
    }

    [Fact]
    public void InPlaceLocationService_Constructor_Should_Throw_When_Repository_Is_Null()
    {
        // Act & Assert
        Assert.Throws<ArgumentNullException>(() => new InPlaceLocationService(null!));
    }

    #endregion

    #region GetAllInPlaceLocationsAsync Tests

    [Fact]
    public async Task GetAllInPlaceLocationsAsync_Should_Return_All_InPlaceLocations_When_InPlaceLocations_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocations = new List<InPlaceLocation>
        {
            new InPlaceLocation(1, 1, 101, 30),
            new InPlaceLocation(2, 1, 102, 25),
            new InPlaceLocation(3, 2, 201, 50)
        };

        mockRepo.GetAllAsync(Arg.Any<CancellationToken>())
            .Returns(inPlaceLocations);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetAllInPlaceLocationsAsync(CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(3, result.Result.Count());
        Assert.Equal("Retrieved 3 in-place location(s) successfully.", result.Message);

        await mockRepo.Received(1).GetAllAsync(Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetAllInPlaceLocationsAsync_Should_Return_Empty_List_When_No_InPlaceLocations_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.GetAllAsync(Arg.Any<CancellationToken>())
            .Returns(new List<InPlaceLocation>());

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetAllInPlaceLocationsAsync(CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Empty(result.Result);
        Assert.Equal("No in-place locations found.", result.Message);
    }

    [Fact]
    public async Task GetAllInPlaceLocationsAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.GetAllAsync(Arg.Any<CancellationToken>())
            .Returns(Task.FromException<IReadOnlyList<InPlaceLocation>>(new Exception("Database connection failed")));

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetAllInPlaceLocationsAsync(CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.Contains("An error occurred while retrieving in-place locations", result.Message);
        Assert.Contains("Database connection failed", result.Message);
    }

    #endregion

    #region GetInPlaceLocationByIdAsync Tests

    [Fact]
    public async Task GetInPlaceLocationByIdAsync_Should_Return_InPlaceLocation_When_InPlaceLocation_Exists()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var inPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(inPlaceLocation);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationByIdAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(inPlaceLocationId, result.Result.Id);
        Assert.Equal(101, result.Result.RoomNumber);
        Assert.Equal("In-place location retrieved successfully.", result.Message);

        await mockRepo.Received(1).GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationByIdAsync_Should_Return_NotFound_When_InPlaceLocation_Does_Not_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns((InPlaceLocation)null!);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationByIdAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(404, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains($"In-place location with ID '{inPlaceLocationId}' not found", result.Message);
    }

    [Fact]
    public async Task GetInPlaceLocationByIdAsync_Should_Return_BadRequest_When_InPlaceLocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationByIdAsync(0, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationByIdAsync_Should_Return_BadRequest_When_InPlaceLocationId_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationByIdAsync(-1, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationByIdAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(Task.FromException<InPlaceLocation?>(new Exception("Database error")));

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationByIdAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("An error occurred while retrieving the in-place location", result.Message);
        Assert.Contains("Database error", result.Message);
    }

    #endregion

    #region GetInPlaceLocationsByLocationIdAsync Tests

    [Fact]
    public async Task GetInPlaceLocationsByLocationIdAsync_Should_Return_InPlaceLocations_When_InPlaceLocations_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var locationId = 1;
        var inPlaceLocations = new List<InPlaceLocation>
        {
            new InPlaceLocation(1, locationId, 101, 30),
            new InPlaceLocation(2, locationId, 102, 25)
        };

        mockRepo.GetInPlaceLocationsByLocationIdAsync(locationId, Arg.Any<CancellationToken>())
            .Returns(inPlaceLocations);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationsByLocationIdAsync(locationId, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(2, result.Result.Count());
        Assert.Equal("Retrieved 2 in-place location(s) for the location successfully.", result.Message);

        await mockRepo.Received(1).GetInPlaceLocationsByLocationIdAsync(locationId, Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationsByLocationIdAsync_Should_Return_Empty_List_When_No_InPlaceLocations_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var locationId = 1;

        mockRepo.GetInPlaceLocationsByLocationIdAsync(locationId, Arg.Any<CancellationToken>())
            .Returns(new List<InPlaceLocation>());

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationsByLocationIdAsync(locationId, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Empty(result.Result);
        Assert.Equal("No in-place locations found for this location.", result.Message);
    }

    [Fact]
    public async Task GetInPlaceLocationsByLocationIdAsync_Should_Return_BadRequest_When_LocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationsByLocationIdAsync(0, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().GetInPlaceLocationsByLocationIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationsByLocationIdAsync_Should_Return_BadRequest_When_LocationId_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationsByLocationIdAsync(-1, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().GetInPlaceLocationsByLocationIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task GetInPlaceLocationsByLocationIdAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var locationId = 1;

        mockRepo.GetInPlaceLocationsByLocationIdAsync(locationId, Arg.Any<CancellationToken>())
            .Returns(Task.FromException<IReadOnlyList<InPlaceLocation>>(new Exception("Database error")));

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.GetInPlaceLocationsByLocationIdAsync(locationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.Contains("An error occurred while retrieving in-place locations", result.Message);
        Assert.Contains("Database error", result.Message);
    }

    #endregion

    #region UpdateInPlaceLocationAsync Tests

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_Success_When_Valid_Input()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);
        var updatedInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 35);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.UpdateAsync(Arg.Any<int>(), Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(updatedInPlaceLocation);

        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(inPlaceLocationId, 1, 101, 35);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.NotNull(result.Result);
        Assert.Equal(35, result.Result.Seats);
        Assert.Equal("In-place location updated successfully.", result.Message);

        await mockRepo.Received(1).UpdateAsync(
            Arg.Is<int>(id => id == inPlaceLocationId),
            Arg.Is<InPlaceLocation>(ipl => ipl.Id == inPlaceLocationId && ipl.Seats == 35),
            Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_BadRequest_When_Input_Is_Null()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(null!, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Equal("In-place location cannot be null.", result.Message);

        await mockRepo.DidNotReceive().UpdateAsync(Arg.Any<int>(), Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_BadRequest_When_InPlaceLocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(0, 1, 101, 30);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_BadRequest_When_LocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>())
            .Returns(new InPlaceLocation(1, 1, 101, 30));
        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(1, 0, 101, 30);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_BadRequest_When_RoomNumber_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>())
            .Returns(new InPlaceLocation(1, 1, 101, 30));
        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(1, 1, 0, 30);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_BadRequest_When_Seats_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        mockRepo.GetByIdAsync(Arg.Any<int>(), Arg.Any<CancellationToken>())
            .Returns(new InPlaceLocation(1, 1, 101, 30));
        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(1, 1, 101, 0);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("greater than zero", result.Message);
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_NotFound_When_InPlaceLocation_Does_Not_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns((InPlaceLocation)null!);

        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(inPlaceLocationId, 1, 101, 30);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(404, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains($"In-place location with ID '{inPlaceLocationId}' not found", result.Message);

        await mockRepo.DidNotReceive().UpdateAsync(Arg.Any<int>(), Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.UpdateAsync(Arg.Any<int>(), Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(Task.FromException<InPlaceLocation?>(new Exception("Database error")));

        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(inPlaceLocationId, 1, 101, 35);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("An error occurred while updating the in-place location", result.Message);
        Assert.Contains("Database error", result.Message);
    }

    [Fact]
    public async Task UpdateInPlaceLocationAsync_Should_Return_Conflict_When_Repository_Throws_DbUpdateException()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.UpdateAsync(Arg.Any<int>(), Arg.Any<InPlaceLocation>(), Arg.Any<CancellationToken>())
            .Returns(Task.FromException<InPlaceLocation?>(new DbUpdateException("FK violation")));

        var service = new InPlaceLocationService(mockRepo);
        var input = new UpdateInPlaceLocationInput(inPlaceLocationId, 9999, 101, 35);

        // Act
        var result = await service.UpdateInPlaceLocationAsync(input, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(409, result.StatusCode);
        Assert.Null(result.Result);
        Assert.Contains("requested location reference is invalid", result.Message);
    }

    #endregion

    #region DeleteInPlaceLocationAsync Tests

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_Success_When_InPlaceLocation_Is_Deleted()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.HasCourseEventsAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(false);

        mockRepo.RemoveAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(true);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.True(result.Success);
        Assert.Equal(200, result.StatusCode);
        Assert.True(result.Result);
        Assert.Equal("In-place location deleted successfully.", result.Message);

        await mockRepo.Received(1).RemoveAsync(inPlaceLocationId, Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_BadRequest_When_InPlaceLocationId_Is_Zero()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(0, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.False(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().RemoveAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_BadRequest_When_InPlaceLocationId_Is_Negative()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(-1, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(400, result.StatusCode);
        Assert.False(result.Result);
        Assert.Contains("greater than zero", result.Message);

        await mockRepo.DidNotReceive().RemoveAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_NotFound_When_InPlaceLocation_Does_Not_Exist()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns((InPlaceLocation)null!);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(404, result.StatusCode);
        Assert.False(result.Result);
        Assert.Contains($"In-place location with ID '{inPlaceLocationId}' not found", result.Message);

        await mockRepo.DidNotReceive().RemoveAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_Conflict_When_InPlaceLocation_Has_CourseEvents()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.HasCourseEventsAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(true);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(409, result.StatusCode);
        Assert.False(result.Result);
        Assert.Contains("Cannot delete in-place location", result.Message);
        Assert.Contains("assigned to course events", result.Message);

        await mockRepo.DidNotReceive().RemoveAsync(Arg.Any<int>(), Arg.Any<CancellationToken>());
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_InternalServerError_When_Repository_Throws_Exception()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.HasCourseEventsAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(false);

        mockRepo.RemoveAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(Task.FromException<bool>(new Exception("Database error")));

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.False(result.Result);
        Assert.Contains("An error occurred while deleting the in-place location", result.Message);
        Assert.Contains("Database error", result.Message);
    }

    [Fact]
    public async Task DeleteInPlaceLocationAsync_Should_Return_InternalServerError_When_Delete_Returns_False()
    {
        // Arrange
        var mockRepo = Substitute.For<IInPlaceLocationRepository>();
        var inPlaceLocationId = 1;
        var existingInPlaceLocation = new InPlaceLocation(inPlaceLocationId, 1, 101, 30);

        mockRepo.GetByIdAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(existingInPlaceLocation);

        mockRepo.HasCourseEventsAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(false);

        mockRepo.RemoveAsync(inPlaceLocationId, Arg.Any<CancellationToken>())
            .Returns(false);

        var service = new InPlaceLocationService(mockRepo);

        // Act
        var result = await service.DeleteInPlaceLocationAsync(inPlaceLocationId, CancellationToken.None);

        // Assert
        Assert.False(result.Success);
        Assert.Equal(500, result.StatusCode);
        Assert.False(result.Result);
        Assert.Equal("Failed to delete in-place location.", result.Message);
    }

    #endregion

    private sealed class DbUpdateException(string message) : Exception(message);
}
